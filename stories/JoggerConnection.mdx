import { Meta } from '@storybook/addon-docs/blocks';

<Meta title="Jogging/JoggerConnection"/>

# Access to Motion Groups and Jogging

## Connect to a motion group

The library provides an easy to use way to access properties of a motion group.

```ts
import { NovaClient } from "@wandelbots/nova-js/v2"
import { ConnectedMotionGroup } from "@wandelbots/wandelbots-js-react-components/core"

const nova = new NovaClient({ instanceUrl: "nova-instance-url" })
const activeRobot = await ConnectedMotionGroup.connect(nova, "motion-group-id")
```

This connected motion group opens a websocket and listens to changes of the current joints and the TCP pose. You can read out those values by using the `rapidlyChangingMotionState` of the object. Along other properties it also provides the current `safetySetup` and `tcps`.

```ts
const newJoints = activeRobot.rapidlyChangingMotionState.joint_position
```

**Api V2 change:** Please not that joints are now directly accessible in `rapidlyChangingMotionState.joint_position`, previously there were nested in `.rapidlyChangingMotionState.state.joint_position.joints`.

## JoggerConnection

Jogging in a robotics context generally refers to the manual movement of the robot via direct human input. The Wandelbots platform provides websocket-based jogging methods which can be used to build similar jogging interfaces to those found on teach pendants.

```ts
import { NovaClient } from "@wandelbots/nova-js/v2"
import { JoggerConnection } from "@wandelbots/wandelbots-js-react-components/core"

const nova = new NovaClient({ instanceUrl: "nova-instance-url" })
const jogger = await JoggerConnection.open(nova, `some-motion-group-id`) // or to set options
// const jogger = await JoggerConnection.open(nova, `some-motion-group-id`), options)
```

The jogger's mode is set to "off" first. You'll need to set it to "jogging" or "trajectory" to be able to
send movement commands

```ts
// Set jogger to "jogging" mode and sends InitializeJoggingRequest to API
await jogger.setJoggingMode("jogging")

// You can update options ater initializing like this:
await jogger.setOptions({
  tcp: "Flange", // TCP id
  timeout: 3000 // How long the promise should wait when server does not respond to init request
  orientation: "tool",
})

// For planned motions, use "trajectory" mode
await jogger.setJoggingMode("trajectory")
await jogger.rotateTCP({...}) // Error: Continuous jogging websocket not connected; ...
await jogger.runIncrementalCartesianMotion({...}) // Plan and run trajectory
```

### Stopping the jogger

For safety purposes, let's first consider how to stop the jogger. Calling stop will stop all motion types regardless of mode:

```ts
await jogger.stop()
```

As a failsafe, the server will also stop any jogging motions when it detects the relevant websocket has been closed. This means that if e.g. the network connection drops out or the browser tab is closed in the middle of a motion, it will stop automatically.

However, you should never totally rely on any software being able to stop the robot: always have the hardware emergency stop button within reach just in case!

### Jogging: Rotating a joint `rotateJoints`

This example starts joint 0 of the robot rotating in a positive direction at 1 radian per second:

```ts
await jogger.rotateJoints({
  joint: 0,
  direction: "+",
  velocityRadsPerSec: 1,
})
```

### Jogging: Moving a TCP `translateTCP`

This example starts moving a TCP in a positive direction along the X axis of the specified coordinate system, at a velocity of 10 millimeters per second:

```ts
await jogger.translateTCP({
  axis: "x",
  direction: "+",
  velocityMmPerSec: 10,
})
```

### Jogging: Rotating a TCP `rotateTCP`

This example starts rotating the TCP in a positive direction around the X axis of the specified coordinate system, at a velocity of 1 radians per second:

```ts
await jogger.rotateTCP({
  axis: "x",
  direction: "+",
  velocityRadsPerSec: 1,
})
```

### Trajectory: Plan and run incremental motion `runIncrementalCartesianMotion`

```ts
await jogger.runIncrementalCartesianMotion({...})
```

### Post-jogging cleanup

When you are done with a jogger, make sure to call dispose:

```ts
await jogger.dispose()
```

This will close any open websockets and ensure things are left in a good state.
